stages:
  - test
  - build_and_push
  - deploy

variables:
  PYTHON_VERSION: "3.10"
  VENV_DIR: ".venv"
  IMAGE_NAME: "ubc/cybersecurity/services/ciso/itsa-test-project/python-api-template-bt"
  IMAGE_TAG: "latest"
  REGISTRY: "registry.infosec.it.ubc.ca"
  PODMAN_REGISTRY_AUTH_FILE: "$CI_PROJECT_DIR/auth.json"  # Authentication for Podman

default:
  image: python:${PYTHON_VERSION}

test:
  stage: test
  script:
    # Check if Homebrew is installed as non root user; if not, install it using Makefile
    - if ! command -v brew &>/dev/null; then
        echo "Homebrew not found. Installing with Makefile...";
        make install-homebrew;
      else
        echo "Homebrew is already installed.";
      fi

    # Verify Homebrew installation for non root user
    - export PATH="/home/linuxbrew/.linuxbrew/bin:$PATH"
    - eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
    - brew --version

    # Verify Homebrew installation
    - brew --version

    # Set up Python environment
    - python3 -m venv ${VENV_DIR}
    - source ${VENV_DIR}/bin/activate
    - pip install --upgrade pip

    # Install Poetry
    - curl -sSL https://install.python-poetry.org | python3 -
    - export PATH="/root/.local/bin:$PATH"  # Add Poetry to PATH

    # Verify Poetry installation
    - poetry --version
    - poetry env use python3

    # Install dependencies with Makefile
    - make deps || { echo "Makefile dependency installation failed"; exit 1; }
    - make test || { echo "Tests failed"; exit 1; }
    - make build || { echo "Build failed"; exit 1; }

  artifacts:
    paths:
      - .
      - dist/
    expire_in: 1 day

build_and_push:
  stage: build_and_push
  image: registry.access.redhat.com/ubi8/podman:latest
  script:
    # Generate a unique version for the image
    - export COMMIT_ID=$(echo $CI_COMMIT_SHORT_SHA)
    - export PIPELINE_ID=$(echo $CI_PIPELINE_ID)
    - export BUILD_VERSION="0.0.0-${COMMIT_ID}-${PIPELINE_ID}"
    - export IMAGE_TAG=$BUILD_VERSION

    # Authenticate Podman to the registry
    - mkdir -p ~/.config/containers
    - podman login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $REGISTRY

    # Build the container image using Podman
    - podman build -t $REGISTRY/$IMAGE_NAME:$IMAGE_TAG .

    # Push the container image to the registry
    - podman push $REGISTRY/$IMAGE_NAME:$IMAGE_TAG

# deploy:
#   stage: deploy
#   tags:
#     - ssh  # Ensure the runner can SSH into the target VM
#   script:
#     # Variables for the target VM
#     - export VM_USER="your-vm-user"
#     - export VM_HOST="your-vm-ip"
#     - export SSH_KEY="/path/to/ssh/private/key" # Add to CI/CD variables for security

#     # Copy SSH key for authentication
#     - mkdir -p ~/.ssh
#     - echo "$SSH_KEY" > ~/.ssh/id_rsa
#     - chmod 600 ~/.ssh/id_rsa

#     # Deploy the container to the target VM using Podman
#     - ssh -o StrictHostKeyChecking=no $VM_USER@$VM_HOST << EOF
#         echo "Authenticating Podman on the target VM...";
#         echo $CI_REGISTRY_PASSWORD | podman login $REGISTRY --username $CI_REGISTRY_USER --password-stdin;

#         echo "Pulling the container image...";
#         podman pull $REGISTRY/$IMAGE_NAME:$IMAGE_TAG;

#         echo "Stopping any running container...";
#         podman stop python-api-template || true;
#         podman rm python-api-template || true;

#         echo "Starting a new container...";
#         podman run -d --name python-api-template -p 8080:8000 $REGISTRY/$IMAGE_NAME:$IMAGE_TAG;
#         echo "Deployment completed.";
#     EOF
