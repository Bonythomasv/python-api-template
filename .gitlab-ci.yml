stages:
  - build_and_test_and_deploy

variables:
  PYTHON_VERSION: "3.10"
  VENV_DIR: ".venv"
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: ""
  DOCKER_REGISTRY: "registry.infosec.it.ubc.ca"
  IMAGE_NAME: "ubc/cybersecurity/services/ciso/itsa-test-project"
  IMAGE_TAG: "latest"
  DOCKER_USERNAME: $CI_REGISTRY_USER
  DOCKER_PASSWORD: $CI_REGISTRY_PASSWORD
default:
  image: python:${PYTHON_VERSION}

services:
  - name: docker:24-dind
    alias: docker
    entrypoint: ["/bin/sh", "-c", "while :; do sleep 10; done"]

before_script:
  # Install Docker CLI if it's not already available
  - if ! command -v docker &>/dev/null; then
      echo "Docker not found, installing Docker CLI...";
      apt-get update && apt-get install -y docker.io;
    fi
  - docker --version  # Verify Docker is available
  # Install Docker Buildx (if not already installed)
  - mkdir -p ~/.docker/cli-plugins
  - curl -Lo ~/.docker/cli-plugins/docker-buildx https://github.com/docker/buildx/releases/download/v0.9.1/buildx-v0.9.1.linux-amd64
  - chmod +x ~/.docker/cli-plugins/docker-buildx
  - docker buildx version
  - docker buildx create --use
  - echo "Checking if Homebrew is installed"
  - if ! command -v brew &>/dev/null; then
      echo "Installing Homebrew";
      NON_ROOT_HOME="/home/linuxbrew";
      mkdir -p $NON_ROOT_HOME && curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh | bash;
      echo 'eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"' >> ~/.bashrc;
      eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)";
    fi
  - export PATH="/home/linuxbrew/.linuxbrew/bin:$PATH"
  - eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
  - echo "Homebrew path setup completed"
  - echo "Installing python3-venv package"
  - apt-get update && apt-get install -y python3-venv || echo "Skipping python3-venv installation for non-root environment"
  - echo "Ensuring Poetry is in PATH"
  - curl -sSL https://install.python-poetry.org | python3 -  # Install Poetry
  - export PATH="$HOME/.local/bin:$PATH"  # Add Poetry to the PATH
  - echo "Poetry installed and path set"
  - echo "Setting up alias for poetry"
  - alias poetry='/root/.local/bin/poetry'  # Create alias for Poetry
  - until docker info; do echo "Waiting for Docker to be ready..."; sleep 5; done

build_and_test_and_deploy:
  stage: build_and_test_and_deploy
  script:
    - echo "Setting up environment"
    - python3 -m venv ${VENV_DIR}
    - source ${VENV_DIR}/bin/activate
    - pip install --upgrade pip
    - echo "Installing dependencies with Makefile"
    - make deps || { echo "Makefile dependency installation failed"; exit 1; }
    - echo "Running check test and build"
    - make deps test build
    - echo "Building Docker image with Docker Buildx"
    - echo $DOCKER_PASSWORD | docker login $DOCKER_REGISTRY --username $DOCKER_USERNAME --password-stdin
    - docker buildx build --context . --file Dockerfile --tag $DOCKER_REGISTRY/$IMAGE_NAME:$IMAGE_TAG --push
    - echo "Docker image built and pushed successfully"
    # - echo "Building Docker image"
    # - docker login registry.infosec.it.ubc.ca -u $DOCKER_USERNAME -p $DOCKER_PASSWORD || { echo "Docker login failed"; exit 1; }
    # - docker build -t target-make-python-devex:latest -t registry.infosec.it.ubc.ca/ubc/cybersecurity/services/ciso/itsa-test-project .
    # - echo "Pushing Docker image"
    # - docker push registry.infosec.it.ubc.ca/ubc/cybersecurity/services/ciso/itsa-test-project:latest

  # artifacts:
  #   when: always
  #   paths:
  #     - dist/example-0.0.0-py3-none-any.whl  # Ensure the .whl file is uploaded as an artifact
  # expire_in: 1 day
