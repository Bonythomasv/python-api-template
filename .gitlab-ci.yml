stages:
  - deps
  - check
  - test
  - build
  - docker

# # Define the agent to be used for the pipeline
# gitlab-agent:
#   name: "my-agent"
#   environment: "non-prod"  # Optional: specify environment if needed

variables:
  PYTHON_VERSION: "3.10"
  VENV_DIR: ".venv"

default:
  image: python:${PYTHON_VERSION}

# Dependency installation stage
deps:
  stage: deps
  script:
    - echo "Setting up environment"
    - python3 -m venv ${VENV_DIR}
    - source ${VENV_DIR}/bin/activate
    - pip install --upgrade pip
    - pip install poetry
    - echo "Installing Homebrew"
    - /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    - echo "Installing dependencies with Brew"
    - brew bundle install --no-lock --verbose --file=Brewfile
    - echo "Installing dependencies with Makefile"
    - make deps
  artifacts:
    paths:
      - ${VENV_DIR}
    expire_in: 1 day

# Show paths and environment
check:
  stage: check
  script:
    - echo "Showing environment paths"
    - echo "${PATH}"
    - command -v pyenv || true
    - command -v poetry || true
    - command -v python3 || true
    - echo "Running make check"
    - make check

# Testing stage
test:
  stage: test
  script:
    - source ${VENV_DIR}/bin/activate
    - echo "Running tests"
    - make test
  artifacts:
    when: always
    paths:
      - tests/reports/

# Build stage
build:
  stage: build
  script:
    - source ${VENV_DIR}/bin/activate
    - echo "Building the project"
    - make build
  artifacts:
    paths:
      - dist/
      - build/

# Docker build and publish stage
docker:
  stage: docker
  script:
    - echo "Logging into Docker registry"
    - docker login registry.infosec.it.ubc.ca -u $DOCKER_USERNAME -p $DOCKER_PASSWORD
    - echo "Building Docker image"
    - docker build -t registry.infosec.it.ubc.ca/ubc/cybersecurity/services/ciso/itsa-test-project .
    - echo "Pushing Docker image"
    - docker push registry.infosec.it.ubc.ca/ubc/cybersecurity/services/ciso/itsa-test-project
  only:
    - main
  variables:
    DOCKER_USERNAME: $CI_REGISTRY_USER
    DOCKER_PASSWORD: $CI_REGISTRY_PASSWORD
